<!DOCTYPE html>
<html>
 <head>
   <base target="_top">
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>G4S Ticket Tracker</title>
 
   <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
   <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
   <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
   <script src="https://cdn.tailwindcss.com"></script>
 
   <script>
     tailwind.config = {
       theme: {
         extend: { colors: { appBlue: '#0033A0', appRed: '#D32F2F', appGray: '#F5F5F5' } }
       }
     }
   </script>
   <style>
     ::-webkit-scrollbar { width: 8px; }
     ::-webkit-scrollbar-track { background: #f1f1f1; }
     ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
     body { font-family: 'Roboto', sans-serif; background-color: #f3f4f6; }
     .animate-fade-in { animation: fadeIn 0.3s ease-out; }
     @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
     .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
     @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
     .toast { position: fixed; bottom: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 14px; animation: slideUp 0.3s ease-out; }
     @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
     .sync-indicator { font-size: 10px; color: #666; display: flex; align-items: center; gap: 4px; }
     .spin-slow { animation: spin 2s linear infinite; }
     @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
     
     .input-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem; display: block; }
     .input-field { width: 100%; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.5rem; font-size: 0.875rem; transition: all 0.2s; outline: none; }
     .input-field:focus { border-color: #D32F2F; ring: 1px solid #D32F2F; }
     .section-title { font-size: 0.95rem; font-weight: 600; color: #374151; margin-bottom: 1rem; margin-top: 1.5rem; }
     .btn-option { border: 1px solid #d1d5db; padding: 0.5rem 1rem; font-size: 0.875rem; color: #4b5563; background: white; transition: all 0.2s; }
     .btn-option:first-child { border-top-left-radius: 0.25rem; border-bottom-left-radius: 0.25rem; }
     .btn-option:last-child { border-top-right-radius: 0.25rem; border-bottom-right-radius: 0.25rem; }
     .btn-option.selected { background-color: #f3f4f6; border-color: #9ca3af; font-weight: 600; color: #111827; }
     .btn-option.selected-red { background-color: #D32F2F; border-color: #D32F2F; color: white; }
   </style>
 </head>
 <body>
   <div id="root"></div>

   <script type="text/babel">
     const { useState, useEffect, useMemo } = React;

     // --- COMUNICACIÓN CON APPS SCRIPT ---
     const runServer = (endpoint, payload = {}) => {
       return new Promise((resolve, reject) => {
         if (typeof google === 'undefined' || !google.script) {
           reject(new Error("Ejecutar en GAS"));
           return;
         }
         google.script.run
           .withSuccessHandler((res) => {
             if (res && res.error) reject(new Error(res.message));
             else resolve(res);
           })
           .withFailureHandler((err) => reject(err))
           .apiHandler({ endpoint, payload });
       });
     };

     // --- ICONOS ---
     const Icon = ({ name, size = 20, className = "" }) => {
       const icons = {
         Home: <><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>,
         ClipboardList: <><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>,
         History: <><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></>,
         FileText: <><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>,
         Image: (
           <>
             <rect x="3" y="5" width="18" height="14" rx="2" ry="2" />
             <circle cx="8.5" cy="11" r="1.3" />
             <polyline points="21 16 17 11 12 16 10 14 6 18" />
           </>
         ),
         ChevronRight: <path d="m9 18 6-6-6-6"/>,
         User: <><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>,
         AlertTriangle: <><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>,
         Download: <><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>,
         Settings: <><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.09a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.09a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.09a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>,
         ShieldCheck: <><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>,
         LogIn: <><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>,
         Search: <><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>,
         RefreshCw: <><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>,
         Info: <><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="8"/><line x1="12" x2="12.01" y2="16"/></>,
         CheckCircle: <><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>,
         Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>,
         CloudLightning: <><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></>,
         Monitor: <><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>,
         X: <><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>,
         CheckBig: <><polyline points="20 6 9 17 4 12"/></>
       };
       return (
         <svg
           xmlns="http://www.w3.org/2000/svg"
           width={size}
           height={size}
           viewBox="0 0 24 24"
           fill="none"
           stroke="currentColor"
           strokeWidth="2"
           strokeLinecap="round"
           strokeLinejoin="round"
           className={className}
         >
           {icons[name] || <circle cx="12" cy="12" r="10" />}
         </svg>
       );
     };

     const Toast = ({ message, onClose }) => {
       useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
       return <div className="toast flex items-center gap-2"><Icon name="Info" className="text-blue-400" /><span>{message}</span></div>;
     };

     const SuccessModal = ({ onClose }) => (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 relative flex flex-col items-center text-center">
                <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><Icon name="X" size={20} /></button>
                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 relative"><div className="absolute inset-0 bg-green-200 rounded-full animate-ping opacity-25"></div><Icon name="CheckBig" size={40} className="text-green-600" /></div>
                <h3 className="text-xl font-bold text-gray-800 mb-2">¡Solicitud Creada!</h3>
                <p className="text-gray-500 text-sm mb-6">Tu ticket ha sido registrado correctamente.</p>
                <button onClick={onClose} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition">Entendido</button>
            </div>
        </div>
     );

     const getStatusTextColor = (status) => {
       if (!status) return 'text-gray-600';
       const s = status.toString().toLowerCase();
       if (s === 'cerrado' || s.includes('resuelto') || s.includes('entregado')) return 'text-green-600';
       if (s.includes('abierto') || s.includes('proceso') || s.includes('ejecución') || s.includes('programado') || s.includes('tramite')) return 'text-blue-600';
       return 'text-yellow-600';
     };
     const getStatusBadgeColor = (status) => {
         if (!status) return 'bg-gray-100 text-gray-600';
         const s = status.toString().toLowerCase();
         if (s === 'cerrado' || s.includes('resuelto') || s.includes('entregado')) return 'bg-green-100 text-green-700';
         if (s.includes('abierto') || s.includes('proceso') || s.includes('ejecución') || s.includes('programado') || s.includes('tramite')) return 'bg-blue-100 text-blue-700';
         return 'bg-yellow-100 text-yellow-700';
     };

     // --- VISTAS ---

     const LoginView = ({ onSuccess, isCheckingCache }) => {
           if (isCheckingCache) return <div className="flex h-screen items-center justify-center bg-gray-100"><img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" alt="G4S" className="h-16 opacity-50 grayscale" /></div>;
           const [loading, setLoading] = useState(false);
           const [errorMsg, setErrorMsg] = useState(null);
           const login = async () => { setLoading(true); try { await onSuccess(null); } catch (e) { setLoading(false); setErrorMsg(e.message); } };
           return (
               <div className="flex flex-col h-screen bg-gray-100">
                   <div className="bg-appRed h-2 w-full"></div>
                   <div className="flex-1 flex items-center justify-center p-4">
                       <div className="bg-white p-8 rounded-xl shadow-lg max-w-md w-full text-center">
                           <div className="flex justify-center mb-6"><img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" alt="G4S" className="h-20 w-auto object-contain" /></div>
                           <h1 className="text-2xl font-bold text-gray-800 mb-2">Ticket Tracker</h1>
                           {errorMsg && <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-left"><h4 className="text-sm font-bold text-red-700">Acceso Denegado</h4><p className="text-xs text-red-600">{errorMsg}</p></div>}
                           {loading ? <div className="py-6"><div className="w-10 h-10 border-4 border-appRed border-t-transparent rounded-full animate-spin mx-auto"></div></div> : <button onClick={login} className="w-full bg-appBlue hover:bg-blue-800 text-white font-bold py-3 px-4 rounded flex items-center justify-center gap-2"><Icon name="User" size={18} /> Ingresar con Google</button>}
                       </div>
                   </div>
               </div>
           );
     };

     const Sidebar = ({ currentView, setView, onLogout, userContext, lastSync, isSyncing }) => {
       const menuItems = [ { id: 'home', icon: 'Home', title: 'Inicio' }, { id: 'create', icon: 'ClipboardList', title: 'Nueva Solicitud' }, { id: 'process', icon: 'Monitor', title: 'Tickets Activos' }, { id: 'history', icon: 'History', title: 'Historial Tickets' } ];
       return (
         <div className="w-64 bg-white h-screen border-r border-gray-200 flex flex-col shadow-lg z-10 fixed">
           <div className="p-6 border-b border-gray-100 flex items-center gap-3 cursor-pointer" onClick={() => setView('home')}><img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" alt="G4S Logo" className="h-8 w-auto object-contain" /><span className="font-bold text-gray-800 text-lg">Ticket Tracker</span></div>
           <div className="flex-1 overflow-y-auto py-4">
             {menuItems.map((item) => (<div key={item.id} onClick={() => setView(item.id)} className={`px-6 py-3 cursor-pointer transition-colors border-l-4 ${currentView === item.id ? 'bg-red-50 border-appRed' : 'border-transparent hover:bg-gray-50'}`}><div className="flex items-center gap-3"><Icon name={item.icon} className={`${currentView === item.id ? 'text-appRed' : 'text-gray-400'}`} size={20} /><div className={`font-medium text-sm ${currentView === item.id ? 'text-appRed font-bold' : 'text-gray-600'}`}>{item.title}</div></div></div>))}
             <div className="my-2 border-t border-gray-100"></div>
             <div onClick={() => setView('config')} className={`px-6 py-3 cursor-pointer transition-colors border-l-4 ${currentView === 'config' ? 'bg-blue-50 border-appBlue' : 'border-transparent hover:bg-gray-50'}`}><div className="flex items-start gap-3"><Icon name="Settings" className={`${currentView === 'config' ? 'text-appBlue' : 'text-gray-400'}`} size={20} /><div className={`font-medium text-sm ${currentView === 'config' ? 'text-appBlue font-bold' : 'text-gray-600'}`}>Configuración</div></div></div>
           </div>
           <div className="p-4 border-t bg-gray-50">
              <div className="flex flex-col gap-2 mb-3">
                <div className="flex items-center gap-2"><div className="p-2 rounded-full bg-gray-200"><Icon name="User" size={16} className="text-gray-600" /></div><div className="overflow-hidden flex-1"><div className="text-[10px] uppercase font-bold text-gray-500">Usuario</div><div className="text-xs font-bold text-gray-800 truncate w-full" title={userContext?.email}>{userContext?.email || '...'}</div></div></div>
                <div className="flex justify-between items-center bg-white border border-gray-200 rounded px-2 py-1">{isSyncing ? <div className="sync-indicator text-blue-600 font-bold"><Icon name="RefreshCw" size={10} className="spin-slow" /> Actualizando...</div> : <div className="sync-indicator"><Icon name="CloudLightning" size={10} /> Al día</div>}{lastSync && <span className="text-[9px] text-gray-400">{new Date(Number(lastSync)).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>}</div>
              </div>
              <button onClick={onLogout} className="w-full py-2 px-3 bg-white border border-gray-300 rounded text-xs font-bold text-gray-700 hover:bg-gray-100 transition flex items-center justify-center gap-2"><Icon name="LogIn" size={14} className="rotate-180"/> Salir</button>
           </div>
         </div>
       );
     };

     const CreateRequest = ({ userContext, setView, onRefresh }) => {
       const [formData, setFormData] = useState({ idSede: '', ticketCliente: '', clasificacion: 'Hardware', tipoServicio: 'Visita técnica', prioridad: 'Media', solicitud: '', observacion: '' });
       const [submitting, setSubmitting] = useState(false);
       const [showSuccess, setShowSuccess] = useState(false);
       const currentDate = useMemo(() => new Date().toLocaleString(), []);

       const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));
       const handleSubmit = () => {
           if (!formData.idSede || !formData.solicitud || !formData.observacion) { alert("Completa los campos obligatorios."); return; }
           setSubmitting(true);
           const payload = { ...formData, observacion: `[Tipo: ${formData.tipoServicio}] ${formData.observacion}` };
           runServer('createRequest', payload).then(() => setShowSuccess(true)).catch(err => { alert("Error: " + err.message); setSubmitting(false); });
       };
       const handleSuccessClose = () => { setShowSuccess(false); setSubmitting(false); if(onRefresh) onRefresh(true); setView('home'); };

       return (
         <div className="p-8 max-w-4xl mx-auto animate-fade-in relative">
           {showSuccess && <SuccessModal onClose={handleSuccessClose} />}
           <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-medium text-gray-800">Crear Solicitud</h2><div className="flex gap-2"><button onClick={() => setView('home')} disabled={submitting} className="px-4 py-2 border border-red-200 text-red-600 rounded text-sm font-medium hover:bg-red-50">Cancelar</button><button onClick={handleSubmit} disabled={submitting} className="bg-appRed text-white px-6 py-2 rounded shadow hover:bg-red-700 font-medium text-sm flex items-center gap-2">{submitting ? "Guardando..." : "Guardar"}</button></div></div>
           <div className="bg-white p-8 rounded shadow-sm border border-gray-200">
             <h3 className="section-title mt-0">Consecutivo Del Ticket</h3>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div><label className="input-label">Ticket G4S *</label><input type="text" className="input-field bg-gray-50 text-gray-400" placeholder="Generado automáticamente" disabled /></div><div><label className="input-label">Ticket (Opcional)</label><input type="text" className="input-field" value={formData.ticketCliente} onChange={(e) => handleChange('ticketCliente', e.target.value)} /></div></div>
             <h3 className="section-title">Sitio Solicitud</h3>
             <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"><div><label className="input-label">Sede *</label><select className="input-field" value={formData.idSede} onChange={(e) => handleChange('idSede', e.target.value)}><option value="">Seleccione Sede...</option>{userContext?.allowedClientIds?.map(id => (<option key={id} value={id}>{userContext.clientNames?.[id] || id}</option>))}</select></div><div><label className="input-label">Fecha creación *</label><div className="relative"><input type="text" className="input-field bg-gray-50 text-gray-600" value={currentDate} readOnly /><div className="absolute right-3 top-2.5 text-gray-400"><Icon name="Clock" size={16}/></div></div></div></div>
             <h3 className="section-title">Motivo Del Servicio</h3>
             <div className="space-y-4 mb-6">
                <div><label className="input-label">Solicitud *</label><input type="text" className="input-field" value={formData.solicitud} onChange={(e) => handleChange('solicitud', e.target.value)} /></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="input-label">Clasificación</label><select className="input-field" value={formData.clasificacion} onChange={(e) => handleChange('clasificacion', e.target.value)}><option value="Hardware">Hardware</option><option value="Software">Software</option><option value="Redes">Redes</option><option value="Acceso">Acceso</option><option value="Otro">Otro</option></select></div><div><label className="input-label">Tipo Servicio</label><div className="flex">{['Visita técnica', 'Visita comercial'].map(t => (<button key={t} onClick={() => handleChange('tipoServicio', t)} className={`btn-option ${formData.tipoServicio === t ? 'selected' : ''}`}>{t}</button>))}</div></div></div>
                <div><label className="input-label">Observación</label><textarea className="input-field h-24" value={formData.observacion} onChange={(e) => handleChange('observacion', e.target.value)}></textarea></div>
                <div><label className="input-label">Prioridad</label><div className="flex">{['Baja', 'Media', 'Alta'].map(p => (<button key={p} onClick={() => handleChange('prioridad', p)} className={`btn-option ${formData.prioridad === p ? 'selected-red' : ''}`}>{p}</button>))}</div></div>
             </div>
           </div>
         </div>
       );
     };

     const RequestDetail = ({ requestId, onBack, preloadedData }) => {
       const [data, setData] = useState(preloadedData ? { header: preloadedData, services: [], history: [], docs: [] } : null);
       const [loading, setLoading] = useState(true);
       const [error, setError] = useState(null);

       useEffect(() => {
         setLoading(true);
         runServer('getRequestDetail', { id: requestId })
           .then(res => {
             setData({
               header: res.header || preloadedData,
               services: res.services || [],
               history: res.history || [],
               docs: res.documents || []
             });
           })
           .catch(e => !preloadedData && setError(e.message))
           .finally(() => setLoading(false));
       }, [requestId]);
     
       if(!data && loading) return <div className="p-10"><div className="skeleton h-10 w-1/3 rounded mb-4"></div><div className="skeleton h-64 w-full rounded"></div></div>;
       if(error && !data) return <div className="p-10 text-red-600">Error: {error}</div>;

       const isRelevantField = (key, value) => {
           if (!value || value === '0') return false;
           const k = key.toLowerCase();
           if (k.includes('id_') || k.includes('_row') || k === 'id solicitud' || k === 'id sede') return false;
           return true;
       };

       const getDocUrl = (doc) => {
         return doc.Url || doc.url || doc.Link || doc.link || doc.Archivo || doc.archivo || doc.File || doc.file;
       };

       const getDocType = (doc) => {
         const rawType =
           (doc['Tipo anexo'] ||
            doc['Tipo Anexo'] ||
            doc['Tipo'] ||
            doc.Tipo ||
            '') + '';
         const t = rawType.toLowerCase();
         if (t) return t;

         const url = (getDocUrl(doc) || '').toLowerCase();
         const name = (doc.Nombre || doc.FileName || doc.Archivo || '').toString().toLowerCase();
         const source = url || name;

         if (/\.(png|jpe?g|gif|bmp|webp)$/i.test(source)) return 'imagen';
         if (/\.pdf$/i.test(source)) return 'pdf';
         return '';
       };

       const isImageAttachment = (doc) => {
         const t = getDocType(doc);
         return (
           t.includes('foto') ||
           t.includes('dibujo') ||
           t.includes('imagen') ||
           t === 'image'
         );
       };

       const Card = ({ title, children, count }) => (
         <div className="bg-white rounded-lg shadow-sm border border-gray-200 mb-4 overflow-hidden">
           <div className="px-4 py-3 border-b border-gray-100 font-bold text-gray-700 text-sm uppercase flex justify-between">
             <span>{title}</span>
             {count !== undefined && <span className="bg-gray-100 text-gray-600 px-2 rounded-full text-xs flex items-center">{count}</span>}
           </div>
           <div className="p-0">{children}</div>
         </div>
       );

       return (
         <div className="p-6 max-w-7xl mx-auto animate-fade-in">
           <button onClick={onBack} className="mb-4 text-gray-500 hover:text-gray-800 flex items-center gap-1 text-sm"><Icon name="ChevronRight" className="rotate-180" size={16}/> Volver</button>
           <div className="grid grid-cols-12 gap-6">
             <div className="col-span-12 md:col-span-8 space-y-4">
               <Card title="Detalle Técnico">
                 <div className="p-4 grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[600px] overflow-y-auto">
                   {Object.entries(data.header).map(([key, value]) => {
                     if (!isRelevantField(key, value)) return null;
                     return (<div key={key} className="border-b border-gray-50 pb-2 last:border-0"><div className="text-[10px] font-bold text-gray-400 uppercase tracking-wide break-words">{key.replace(/([A-Z])/g, ' $1').trim()}</div><div className="text-sm text-gray-700 break-words font-medium">{value}</div></div>);
                   })}
                 </div>
               </Card>
             </div>
             <div className="col-span-12 md:col-span-4 space-y-4">
               <div className="bg-white p-6 rounded-lg shadow-sm border border-gray-200 text-center">
                 <div className="text-gray-400 text-xs font-bold mb-1">ESTADO TICKET</div>
                 <div className={`text-2xl font-black mb-2 uppercase ${getStatusTextColor(data.header['Estado'])}`}>{data.header['Estado'] || 'Desconocido'}</div>
                 <div className="text-gray-500 text-xs bg-gray-100 inline-block px-2 py-1 rounded">Ticket #: {data.header['Ticket G4S'] || data.header['ID Solicitud']}</div>
               </div>
               
               {loading && <div className="text-xs text-blue-600 mb-2 flex items-center gap-2"><div className="w-3 h-3 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div> Actualizando detalles...</div>}

               <Card title="Observaciones" count={data.services.length}>
                 <ul className="divide-y divide-gray-100 max-h-48 overflow-y-auto">
                     {data.services.map((s,i) => (
                        <li key={i} className="px-4 py-3 text-sm flex justify-between items-center hover:bg-gray-50">
                            <span className="font-medium text-gray-700">
                                {s.Observacion || s['Observación'] || s.Observaciones || s['Observaciones'] || s.Nota || s.Detalle || s.Comentario || s.Descripcion || "Sin contenido"}
                            </span>
                            <span className="text-[10px] text-gray-400">
                                {s.Fecha || s.fecha || '-'}
                            </span>
                        </li>
                     ))}
                     {data.services.length===0 && <div className="p-4 text-center text-xs text-gray-400 italic">No hay observaciones.</div>}
                 </ul>
               </Card>

               <Card title="Anexos" count={data.docs.length}>
                   <ul className="divide-y divide-gray-100 max-h-48 overflow-y-auto">
                       {data.docs.map((doc, i) => {
                           const fileUrl = getDocUrl(doc);
                           const isImg = isImageAttachment(doc);
                           const label = doc.Nombre || doc.FileName || doc.Archivo || (isImg ? 'Imagen' : 'Archivo');

                           return (
                               <li key={i} className="px-4 py-2 flex items-center gap-3 hover:bg-gray-50">
                                   <div className={`${isImg ? 'text-blue-500' : 'text-red-500'} flex-shrink-0`}>
                                     <Icon name={isImg ? 'Image' : 'FileText'} size={16}/>
                                   </div>
                                   <div className="flex-1 overflow-hidden">
                                       <div className="text-gray-700 text-xs truncate font-medium">{label}</div>
                                       {isImg && fileUrl && (
                                         <div className="mt-1">
                                           <img
                                             src={fileUrl}
                                             alt={label}
                                             className="w-16 h-10 object-cover rounded border border-gray-200"
                                           />
                                         </div>
                                       )}
                                   </div>
                                   {fileUrl && (
                                       <a href={fileUrl} target="_blank" rel="noopener noreferrer" className="text-gray-400 hover:text-blue-600 transition p-1 rounded hover:bg-blue-50" title="Abrir">
                                           <Icon name="Download" size={16}/>
                                       </a>
                                   )}
                               </li>
                           );
                       })}
                       {data.docs.length===0 && <div className="p-4 text-center text-xs text-gray-400 italic">No hay adjuntos.</div>}
                   </ul>
               </Card>
               <Card title="Historial" count={data.history.length}>
                   <ul className="divide-y divide-gray-100 max-h-48 overflow-y-auto">
                       {data.history.map((h, i) => (
                         <li key={i} className="px-4 py-2 hover:bg-gray-50">
                           <div className="text-xs font-bold text-gray-700">{h['Estado actual'] || h.Estado}</div>
                           <div className="text-[10px] text-gray-400">{h['Fecha Actualización'] || h.Fecha}</div>
                           <div className="text-[9px] text-gray-500 italic mt-1">{h['Usuario Actualización']}</div>
                         </li>
                       ))}
                       {data.history.length===0 && <div className="p-4 text-center text-xs text-gray-400 italic">Sin historial reciente.</div>}
                   </ul>
               </Card>
             </div>
           </div>
         </div>
       );
     };

     const RequestList = ({ setView, setSelectedRequest, initialData, onRefresh, refreshing }) => {
       const [filter, setFilter] = useState('Todo');
       const [search, setSearch] = useState('');
       const [requests, setRequests] = useState(initialData?.data || []);
       const [filtered, setFiltered] = useState([]);
       
       useEffect(() => { if(initialData) setRequests(initialData.data || []); }, [initialData]);
       useEffect(() => {
           let r = requests;
           if (filter === 'Abierto') r = r.filter(req => (req['Estado'] || '').trim() !== 'Cerrado');
           if (filter === 'Cerrado') r = r.filter(req => (req['Estado'] || '').trim() === 'Cerrado');
           if (search) { const q = search.toLowerCase(); r = r.filter(req => JSON.stringify(req).toLowerCase().includes(q)); }
           setFiltered(r);
       }, [requests, filter, search]);

       return (
         <div className="p-6 h-full flex flex-col">
           <div className="flex justify-between items-center mb-4"><div className="relative w-64"><div className="absolute left-3 top-2.5 text-gray-400"><Icon name="Search" size={16}/></div><input type="text" className="w-full pl-10 pr-3 py-2 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-appBlue" placeholder="Buscar ticket..." value={search} onChange={e=>setSearch(e.target.value)}/></div><div className="flex items-center gap-2"><button onClick={onRefresh} disabled={refreshing} className="p-2 text-gray-500 hover:text-blue-600 transition border rounded bg-white"><Icon name="RefreshCw" size={18} className={refreshing?"animate-spin text-blue-600":""}/></button><span className="text-xs font-bold text-gray-500">Total: {filtered.length}</span></div></div>
           <div className="flex gap-2 mb-4">{['Todo', 'Abierto', 'Cerrado'].map(f=><button key={f} onClick={()=>setFilter(f)} className={`px-3 py-1 rounded-full text-xs font-bold transition ${filter===f?'bg-gray-800 text-white':'bg-white border text-gray-600'}`}>{f}</button>)}</div>
           <div className="bg-white rounded-lg shadow-sm border overflow-hidden flex-1 flex flex-col">
              <div className="grid grid-cols-12 gap-2 p-3 border-b bg-gray-50 text-xs font-bold text-gray-400 uppercase"><div className="col-span-2">Ticket</div><div className="col-span-2">Fecha</div><div className="col-span-3">Clasificación</div><div className="col-span-3">Solicitud</div><div className="col-span-2 text-right">Estado</div></div>
              <div className="overflow-y-auto flex-1">
                  {filtered.length===0 && <div className="p-10 text-center text-gray-400 italic">No hay tickets.</div>}
                  {filtered.map((req, i) => (
                    <div key={i} onClick={() => { setSelectedRequest(req); setView('detail'); }} className="grid grid-cols-12 gap-2 p-3 border-b hover:bg-gray-50 cursor-pointer text-sm items-center transition-colors">
                      <div className="col-span-2 font-bold text-blue-600 truncate">{req['Ticket G4S'] || req['ID Solicitud']}</div>
                      <div className="col-span-2 text-xs text-gray-500">{req['Fecha creación cliente']?.split('T')[0] || '-'}</div>
                      <div className="col-span-3 text-xs">{req['Clasificación']}</div>
                      <div className="col-span-3 truncate font-medium">{req['Solicitud']}</div>
                      <div className="col-span-2 text-right"><span className={`px-2 py-1 rounded text-[10px] font-bold uppercase ${getStatusBadgeColor(req['Estado'])}`}>{req['Estado']}</span></div>
                    </div>
                  ))}
              </div>
           </div>
         </div>
       );
     };

     const HomeDashboard = ({ userContext, requests, setView, isSyncing }) => {
        const stats = { total: requests.length, open: requests.filter(r=>(r.Estado||'').trim()!=='Cerrado').length, closed: requests.filter(r=>(r.Estado||'').trim()==='Cerrado').length };
        return (
            <div className="p-8 max-w-6xl mx-auto animate-fade-in">
                <div className="mb-8"><div className="flex items-center gap-3"><h1 className="text-3xl font-bold text-gray-800">Hola, {userContext.email.split('@')[0]}</h1>{isSyncing && <div className="flex items-center gap-2 bg-blue-50 px-3 py-1 rounded-full border border-blue-100"><div className="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div><span className="text-xs font-bold text-blue-600">Sincronizando...</span></div>}</div><p className="text-gray-500">Bienvenido al portal de Gestión.</p></div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                    <div onClick={()=>setView('history')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition transform hover:-translate-y-1"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-blue-50 text-blue-600 rounded-lg"><Icon name="FileText" size={24} /></div><span className="text-xs font-bold text-gray-400 uppercase">Total Tickets</span></div><div className="text-3xl font-bold text-gray-800">{stats.total}</div></div>
                    <div onClick={()=>setView('process')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition transform hover:-translate-y-1"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-yellow-50 text-yellow-600 rounded-lg"><Icon name="Clock" size={24} /></div><span className="text-xs font-bold text-gray-400 uppercase">Abiertos</span></div><div className="text-3xl font-bold text-gray-800">{stats.open}</div></div>
                    <div onClick={()=>setView('history')} className="bg-white p-6 rounded-xl shadow-sm border border-gray-200 cursor-pointer hover:shadow-md transition transform hover:-translate-y-1"><div className="flex justify-between items-start mb-4"><div className="p-3 bg-green-50 text-green-600 rounded-lg"><Icon name="CheckCircle" size={24} /></div><span className="text-xs font-bold text-gray-400 uppercase">Cerrados</span></div><div className="text-3xl font-bold text-gray-800">{stats.closed}</div></div>
                </div>
                <h2 className="text-xl font-bold text-gray-800 mb-4">Acciones Rápidas</h2>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><button onClick={() => setView('create')} className="flex items-center gap-4 p-6 bg-gradient-to-r from-appRed to-red-700 text-white rounded-xl shadow hover:shadow-lg transition text-left col-span-2 md:col-span-1"><div className="bg-white/20 p-3 rounded-full"><Icon name="ClipboardList" size={32} /></div><div><div className="text-lg font-bold">Crear nuevo Ticket</div><div className="text-white/80 text-sm">Reportar un fallo o solicitar servicio.</div></div></button></div>
            </div>
        );
     };

     const ConfigurationView = ({ userContext, onForceSync, isSyncing }) => (
        <div className="p-8"><h2 className="text-2xl font-bold mb-4">Configuración</h2><div className="bg-white p-6 rounded shadow"><p><strong>Usuario:</strong> {userContext.email}</p><p><strong>Rol:</strong> {userContext.role}</p><button onClick={onForceSync} disabled={isSyncing} className="mt-4 bg-blue-600 text-white px-4 py-2 rounded">{isSyncing?"Sincronizando...":"Actualizar Datos"}</button></div></div>
     );

     const App = () => {
       const [userCtx, setUserCtx] = useState(null);
       const [initialData, setInitialData] = useState(null);
       const [view, setView] = useState('create');
       const [selectedRequest, setSelectedRequest] = useState(null);
       const [isSyncing, setIsSyncing] = useState(false);
       const [lastSync, setLastSync] = useState(null);
       const [isCheckingCache, setIsCheckingCache] = useState(true);

       const loadFromCache = (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } };
       const refreshData = async (manual = false) => {
           if (!userCtx) return;
           setIsSyncing(true);
           try {
             const d = await runServer('getRequests', {});
             setInitialData(d);
             setLastSync(Date.now());
             localStorage.setItem(`data_${userCtx.email}`, JSON.stringify(d));
           } catch (e) {
             console.error(e);
           } finally {
             setIsSyncing(false);
           }
       };

       useEffect(() => {
           const init = async () => {
               const lastEmail = localStorage.getItem('last_email');
               if (lastEmail) {
                   const c = loadFromCache(`ctx_${lastEmail}`);
                   const d = loadFromCache(`data_${lastEmail}`);
                   if (c && d) { setUserCtx(c); setInitialData(d); setView('home'); }
               }
               try {
                   const ctx = await runServer('getUserContext', {});
                   if (!ctx.isValidUser) throw new Error("Sin permisos");
                   setUserCtx(ctx);
                   localStorage.setItem('last_email', ctx.email);
                   localStorage.setItem(`ctx_${ctx.email}`, JSON.stringify(ctx));
                   const d = await runServer('getRequests', {});
                   setInitialData(d);
                   localStorage.setItem(`data_${ctx.email}`, JSON.stringify(d));
                   if (!lastEmail) setView('home');
               } catch (e) {
                   console.error(e);
               } finally {
                   setIsCheckingCache(false);
               }
           };
           init();
       }, []);

       if (!userCtx) return <LoginView onSuccess={() => window.location.reload()} isCheckingCache={isCheckingCache} />;

       return (
         <div className="flex h-screen bg-gray-100 text-gray-800 animate-fade-in">
           <Sidebar currentView={view} setView={setView} onLogout={() => { localStorage.clear(); window.location.reload(); }} userContext={userCtx} lastSync={lastSync} isSyncing={isSyncing} />
           <div className="flex-1 ml-64 overflow-y-auto">
             {view === 'home' ? (
               <HomeDashboard userContext={userCtx} requests={initialData?.data || []} setView={setView} isSyncing={isSyncing} />
             ) : view === 'detail' && selectedRequest ? (
               <RequestDetail requestId={selectedRequest['ID Solicitud']} preloadedData={selectedRequest} onBack={() => setView('history')} />
             ) : view === 'create' ? (
               <CreateRequest userContext={userCtx} setView={setView} onRefresh={() => refreshData(true)} />
             ) : view === 'config' ? (
               <ConfigurationView userContext={userCtx} onForceSync={() => refreshData(true)} isSyncing={isSyncing} />
             ) : (
               <RequestList setView={setView} setSelectedRequest={setSelectedRequest} initialData={initialData} onRefresh={() => refreshData(true)} refreshing={isSyncing} />
             )}
           </div>
         </div>
       );
     };
   
     const root = ReactDOM.createRoot(document.getElementById('root'));
     root.render(<App />);
   </script>
 </body>
</html>
