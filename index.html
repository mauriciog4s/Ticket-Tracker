<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G4S Assets Viewer Pro</title>
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    body { background-color: #f3f4f6; font-family: sans-serif; overflow: hidden; }
    
    /* Loader Spinner */
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #ce1126; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    
    /* Scrollbar Fino */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* Cursor para el mapa */
    .grab-cursor { cursor: grab; }
    .grab-cursor:active { cursor: grabbing; }
    
    /* Animaciones */
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .animate-fadeIn { animation: fadeIn 0.2s ease-out forwards; }
    
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .animate-slideIn { animation: slideIn 0.3s ease-out forwards; }
  </style>
</head>
<body>
  <div id="root" class="h-screen flex flex-col"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- CONFIGURACIÓN ---
    const APPSHEET_CONFIG = {
        appName: "AppAutomatizacion-3428007", 
        tableName: "Activos" 
    };
    const PISOS_TABLE_NAME = "Pisos"; 

    // --- API HELPER ---
    const api = {
      get: (action, payload) => new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(resolve)
          .withFailureHandler(reject)
          .getData(action, payload);
      })
    };

    // --- GENERADOR URL ---
    const getAppSheetUrl = (fileName, overrideTable = null, isImage = true) => {
        if (!fileName) return null;
        if (fileName.startsWith('http')) return fileName;
        const encoded = encodeURIComponent(fileName);
        const table = overrideTable || APPSHEET_CONFIG.tableName;
        const endpoint = isImage ? "image/getimageurl" : "template/gettablefileurl";
        return `https://www.appsheet.com/${endpoint}?appName=${APPSHEET_CONFIG.appName}&tableName=${table}&fileName=${encoded}`;
    };

    // --- COMPONENTE: VISOR DE MAPA (ZOOM & PAN) ---
    const MapViewer = ({ imageUrl, assets, onAssetClick, getIcon }) => {
        const [scale, setScale] = useState(1);
        const [position, setPosition] = useState({ x: 0, y: 0 });
        const [isDragging, setIsDragging] = useState(false);
        const [startPos, setStartPos] = useState({ x: 0, y: 0 });
        const containerRef = useRef(null);

        const handleWheel = (e) => {
            e.preventDefault();
            const scaleAdjustment = e.deltaY * -0.001;
            const newScale = Math.min(Math.max(.5, scale + scaleAdjustment), 4);
            setScale(newScale);
        };

        const handleMouseDown = (e) => {
            setIsDragging(true);
            setStartPos({ x: e.clientX - position.x, y: e.clientY - position.y });
        };

        const handleMouseMove = (e) => {
            if (!isDragging) return;
            e.preventDefault();
            setPosition({ x: e.clientX - startPos.x, y: e.clientY - startPos.y });
        };

        const handleMouseUp = () => setIsDragging(false);

        useEffect(() => { setScale(1); setPosition({ x: 0, y: 0 }); }, [imageUrl]);

        return (
            <div 
                ref={containerRef}
                className="w-full h-full bg-gray-200 overflow-hidden relative grab-cursor flex items-center justify-center"
                onWheel={handleWheel}
                onMouseDown={handleMouseDown}
                onMouseMove={handleMouseMove}
                onMouseUp={handleMouseUp}
                onMouseLeave={handleMouseUp}
            >
                <div 
                    style={{ 
                        transform: `translate(${position.x}px, ${position.y}px) scale(${scale})`,
                        transformOrigin: "center center",
                        transition: isDragging ? 'none' : 'transform 0.1s ease-out'
                    }}
                    className="relative shadow-xl inline-block bg-white"
                >
                    <img src={imageUrl} className="max-w-none block pointer-events-none select-none" style={{ height: '800px' }} alt="Plano"/>
                    
                    {assets.map(asset => {
                        if (!asset.coord_x || !asset.coord_y) return null;
                        return (
                            <div 
                                key={asset.id_activo} 
                                onClick={(e) => { e.stopPropagation(); onAssetClick(asset); }}
                                className={`absolute w-6 h-6 -ml-3 -mt-3 rounded-full border-2 border-white shadow-lg cursor-pointer flex items-center justify-center text-[10px] text-white hover:scale-125 transition-transform z-10 hover:z-20
                                    ${asset.estado_activo === 'Operativo' ? 'bg-green-600' : 'bg-red-600'}`}
                                style={{ left: `${asset.coord_x}%`, top: `${asset.coord_y}%` }}
                                title={asset.nombre_activo}
                            >
                                <i className={`fas ${getIcon(asset.tipo_dispositivo)}`}></i>
                            </div>
                        )
                    })}
                </div>
                <div className="absolute bottom-4 right-4 flex flex-col gap-2 bg-white rounded shadow border z-30">
                    <button onClick={() => setScale(s => Math.min(s + 0.5, 4))} className="p-2 hover:bg-gray-100 text-gray-600"><i className="fas fa-plus"></i></button>
                    <button onClick={() => { setScale(1); setPosition({x:0, y:0}); }} className="p-2 hover:bg-gray-100 text-gray-600 border-t border-b"><i className="fas fa-compress"></i></button>
                    <button onClick={() => setScale(s => Math.max(s - 0.5, 0.5))} className="p-2 hover:bg-gray-100 text-gray-600"><i className="fas fa-minus"></i></button>
                </div>
            </div>
        );
    };

    // --- COMPONENT: MODAL DE ARCHIVOS (LIMPIO Y SEGURO) ---
    const FileModal = ({ fileUrl, type, onClose }) => {
        if (!fileUrl) return null;

        const renderContent = () => {
            if (type === 'image') {
                return <img src={fileUrl} className="max-w-full max-h-full object-contain shadow-lg" />;
            } else {
                // Truco Google Viewer para evitar bloqueo X-Frame
                const googleViewerUrl = `https://docs.google.com/gview?url=${encodeURIComponent(fileUrl)}&embedded=true`;
                return (
                    <div className="w-full h-full relative bg-gray-100">
                        <iframe src={googleViewerUrl} className="w-full h-full" frameBorder="0" title="Visor"></iframe>
                        <div className="absolute bottom-4 left-0 right-0 text-center pointer-events-none">
                            <span className="bg-white/80 px-4 py-2 rounded-full text-xs text-gray-500 shadow border">
                                Cargando vista previa...
                            </span>
                        </div>
                    </div>
                );
            }
        };

        return (
            <div className="fixed inset-0 z-50 bg-black/95 flex flex-col items-center justify-center p-4 animate-fadeIn backdrop-blur-sm">
                <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-center text-white bg-gradient-to-b from-black/80 to-transparent z-10">
                    <div className="flex items-center gap-3">
                        <div className="bg-white/10 p-2 rounded-full">
                            <i className={`fas ${type === 'image' ? 'fa-image' : 'fa-file-pdf'}`}></i>
                        </div>
                        <h3 className="font-bold text-sm md:text-base">Visualización de Archivo</h3>
                    </div>
                    <button onClick={onClose} className="bg-white/20 hover:bg-white/40 rounded-full w-9 h-9 flex items-center justify-center transition-colors">
                        <i className="fas fa-times"></i>
                    </button>
                </div>
                <div className="w-full h-full max-w-6xl max-h-[85vh] bg-transparent rounded-lg overflow-hidden flex items-center justify-center relative mt-8 border border-white/10">
                    {renderContent()}
                </div>
            </div>
        );
    };

    // --- COMPONENT: JSON BLOCK INTELIGENTE (COLAPSABLE + FOTOS + SI/NO + FECHA) ---
    const JsonBlock = ({title, data, icon, color, onLinkClick, date}) => {
      if (!data) return null;
      let obj = {};
      try { obj = JSON.parse(data); } catch(e) { return null; }
      if (Object.keys(obj).length === 0) return null;

      // Estado inicial: Cerrado
      const [isOpen, setIsOpen] = useState(false);

      // Formato Fecha
      const displayDate = date ? String(date).split('T')[0] : '';

      const formatValue = (val) => {
        // Formato Booleans
        if (val === true || val === 'true') return <span className="text-green-600 font-bold text-[10px] bg-green-50 px-2 py-0.5 rounded border border-green-200">SI</span>;
        if (val === false || val === 'false') return <span className="text-red-500 font-bold text-[10px] bg-red-50 px-2 py-0.5 rounded border border-red-200">NO</span>;
        return val;
      };

      return (
        <div className="mb-4 border rounded-lg overflow-hidden bg-white shadow-sm transition-all duration-200">
          <div 
            className="bg-gray-50 px-4 py-3 border-b flex items-center justify-between cursor-pointer hover:bg-gray-100 select-none"
            onClick={() => setIsOpen(!isOpen)}
          >
            <div className="flex items-center gap-2 flex-1">
                <i className={`fas ${icon} ${color} text-sm`}></i>
                <span className="font-bold text-xs text-gray-700 uppercase tracking-wide">{title}</span>
                {/* FECHA A LA DERECHA */}
                {displayDate && (
                    <span className="ml-auto mr-2 text-[10px] text-gray-500 font-mono bg-gray-100 px-2 py-0.5 rounded border">
                        <i className="fas fa-calendar-alt mr-1 text-gray-400"></i> {displayDate}
                    </span>
                )}
            </div>
            <i className={`fas fa-chevron-down text-gray-400 text-xs transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}></i>
          </div>

          {isOpen && (
            <div className="p-3 space-y-2 bg-white animate-fadeIn">
                {Object.entries(obj).map(([k, v]) => {
                const valStr = String(v);
                const lowerVal = valStr.toLowerCase();
                
                // Detección Inteligente de Archivos
                const isImage = lowerVal.includes('.jpg') || lowerVal.includes('.jpeg') || lowerVal.includes('.png') || valStr.includes('_Images/');
                const isPdf = lowerVal.includes('.pdf');
                
                return (
                    <div key={k} className="flex justify-between items-center text-xs border-b border-gray-50 pb-2 last:border-0 last:pb-0">
                        <span className="text-gray-500 font-medium w-1/2 pr-2 break-words">{k.replace(/_/g, ' ')}</span>
                        <span className="text-gray-900 font-semibold w-1/2 text-right break-words flex justify-end">
                            {isImage ? (
                                <button 
                                    onClick={() => onLinkClick(valStr, true)} 
                                    className="bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-800 border border-blue-200 px-3 py-1 rounded-full flex items-center gap-1 transition-colors"
                                >
                                    <i className="fas fa-camera"></i> Ver Foto
                                </button>
                            ) : isPdf ? (
                                <button 
                                    onClick={() => onLinkClick(valStr, false)} 
                                    className="bg-orange-50 text-orange-600 hover:bg-orange-100 hover:text-orange-800 border border-orange-200 px-3 py-1 rounded-full flex items-center gap-1 transition-colors"
                                >
                                    <i className="fas fa-file-pdf"></i> Ver Archivo
                                </button>
                            ) : (
                                formatValue(v)
                            )}
                        </span>
                    </div>
                )
                })}
            </div>
          )}
        </div>
      )
    };

    // --- APP PRINCIPAL ---
    const App = () => {
      const [clients, setClients] = useState([]);
      const [sites, setSites] = useState([]);
      const [floors, setFloors] = useState([]);
      const [assets, setAssets] = useState([]);
      const [selClient, setSelClient] = useState('');
      const [selSite, setSelSite] = useState('');
      const [selFloor, setSelFloor] = useState(''); 
      const [floorInfo, setFloorInfo] = useState(null); 
      const [selAsset, setSelAsset] = useState(null);
      const [loading, setLoading] = useState(false);
      const [viewMode, setViewMode] = useState('grid'); 
      const [previewFile, setPreviewFile] = useState(null);

      useEffect(() => { setLoading(true); api.get('getClients').then(d => { setClients(d); setLoading(false); }); }, []);

      useEffect(() => {
        setSites([]); setFloors([]); setAssets([]); setSelSite(''); setSelFloor(''); setSelAsset(null);
        if (selClient) { setLoading(true); api.get('getSites', { clientId: selClient }).then(d => { setSites(d); setLoading(false); }); }
      }, [selClient]);

      useEffect(() => {
        setFloors([]); setAssets([]); setSelFloor(''); setSelAsset(null);
        if (selSite) { setLoading(true); api.get('getFloors', { siteId: selSite }).then(d => { setFloors(d); setLoading(false); }); }
      }, [selSite]);

      useEffect(() => {
        setAssets([]); setSelAsset(null);
        if (selFloor) {
          setLoading(true);
          const currentFloor = floors.find(f => f.id_piso === selFloor);
          setFloorInfo(currentFloor);
          if (currentFloor?.imagen_plano_url) setViewMode('map'); else setViewMode('grid');
          api.get('getAssets', { floorId: selFloor }).then(d => { setAssets(d); setLoading(false); });
        }
      }, [selFloor]);

      const openPreview = (fileName, isImage = true) => {
          if(!fileName) return;
          const url = getAppSheetUrl(fileName, null, isImage);
          setPreviewFile({ url: url, type: isImage ? 'image' : 'pdf', name: fileName });
      };

      return (
        <div className="flex flex-col h-full bg-gray-100 font-sans">
          {/* HEADER */}
          <div className="bg-white border-b px-6 py-4 shadow-sm flex flex-col md:flex-row gap-4 items-center justify-between z-20">
             <div className="flex items-center gap-3">
               <img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" className="h-8"/>
               <h1 className="font-bold text-gray-700 text-lg hidden sm:block">Portal de Activos</h1>
             </div>
             <div className="flex gap-2 w-full md:w-auto">
               <select className="border rounded px-3 py-2 text-sm w-full md:w-48 bg-gray-50 outline-none focus:border-red-600" value={selClient} onChange={e => setSelClient(e.target.value)}><option value="">1. Cliente</option>{clients.map(c => <option key={c.id_cliente} value={c.id_cliente}>{c.nombre_cliente}</option>)}</select>
               <select className="border rounded px-3 py-2 text-sm w-full md:w-48 bg-gray-50 outline-none focus:border-red-600 disabled:opacity-50" value={selSite} onChange={e => setSelSite(e.target.value)} disabled={!selClient}><option value="">2. Sede</option>{sites.map(s => <option key={s.id_sede} value={s.id_sede}>{s.nombre_sede}</option>)}</select>
               <select className="border rounded px-3 py-2 text-sm w-full md:w-48 bg-gray-50 outline-none focus:border-red-600 disabled:opacity-50" value={selFloor} onChange={e => setSelFloor(e.target.value)} disabled={!selSite}><option value="">3. Piso</option>{floors.map(f => <option key={f.id_piso} value={f.id_piso}>{f.nombre_piso}</option>)}</select>
             </div>
          </div>

          <div className="flex-1 relative overflow-hidden flex">
            {loading && <div className="absolute inset-0 bg-white/60 z-50 flex items-center justify-center backdrop-blur-sm"><div className="loader"></div></div>}

            <div className="flex-1 overflow-y-auto p-4 relative bg-slate-100">
               {!selFloor ? (
                 <div className="h-full flex flex-col items-center justify-center text-gray-400"><i className="fas fa-layer-group text-4xl mb-2"></i><p>Selecciona un piso</p></div>
               ) : (
                 <>
                   <div className="absolute top-4 right-6 z-10 flex bg-white rounded shadow border overflow-hidden">
                     <button onClick={()=>setViewMode('grid')} className={`px-3 py-1 text-xs font-bold ${viewMode==='grid'?'bg-gray-800 text-white':'text-gray-600 hover:bg-gray-50'}`}><i className="fas fa-th mr-1"></i> Grid</button>
                     <button onClick={()=>setViewMode('map')} disabled={!floorInfo?.imagen_plano_url} className={`px-3 py-1 text-xs font-bold ${viewMode==='map'?'bg-gray-800 text-white':'text-gray-600 hover:bg-gray-50 disabled:opacity-50'}`}><i className="fas fa-map mr-1"></i> Plano</button>
                   </div>

                   {/* VISTA GRID */}
                   {viewMode === 'grid' && (
                     <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 mt-10 pb-20">
                       {assets.map(asset => (
                         <div key={asset.id_activo} onClick={() => setSelAsset(asset)} className="bg-white p-3 rounded-lg border shadow-sm hover:shadow-md cursor-pointer transition-all hover:-translate-y-1 group">
                           <div className="aspect-video bg-gray-100 rounded mb-2 overflow-hidden relative flex items-center justify-center">
                             {asset.foto_1 ? (
                               <img src={getAppSheetUrl(asset.foto_1)} className="w-full h-full object-cover group-hover:scale-105 transition-transform" onError={(e)=>e.target.style.display='none'}/>
                             ) : <i className="fas fa-cube text-gray-300 text-2xl"></i>}
                             <div className={`absolute top-2 right-2 w-2.5 h-2.5 rounded-full border border-white ${asset.estado_activo==='Operativo'?'bg-green-500':'bg-red-500'}`}></div>
                           </div>
                           <h3 className="font-bold text-gray-800 text-xs truncate">{asset.nombre_activo}</h3>
                           <p className="text-[10px] text-gray-500">{asset.tipo_dispositivo}</p>
                         </div>
                       ))}
                     </div>
                   )}

                   {/* VISTA MAPA (Con Zoom y Pan) */}
                   {viewMode === 'map' && (
                     <MapViewer 
                        imageUrl={getAppSheetUrl(floorInfo.imagen_plano_url, PISOS_TABLE_NAME)}
                        assets={assets}
                        onAssetClick={setSelAsset}
                        getIcon={getIcon}
                     />
                   )}
                 </>
               )}
            </div>

            {/* PANEL LATERAL */}
            {selAsset && (
              <div className="w-96 bg-white border-l shadow-2xl absolute right-0 top-0 bottom-0 z-40 flex flex-col animate-slideIn">
                <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                  <h2 className="font-bold text-gray-800 text-sm uppercase">Detalle</h2>
                  <button onClick={() => setSelAsset(null)} className="text-gray-400 hover:text-red-600"><i className="fas fa-times text-lg"></i></button>
                </div>
                
                <div className="flex-1 overflow-y-auto p-5 scroll-smooth">
                   <div className="flex gap-4 mb-6">
                      <div className="w-20 h-20 bg-gray-100 rounded-lg overflow-hidden flex-shrink-0 border cursor-pointer hover:opacity-80" onClick={() => openPreview(selAsset.foto_1, true)}>
                        {selAsset.foto_1 ? <img src={getAppSheetUrl(selAsset.foto_1)} className="w-full h-full object-cover"/> : <div className="h-full flex items-center justify-center text-gray-400"><i className="fas fa-image"></i></div>}
                      </div>
                      <div>
                        <h1 className="font-bold text-gray-900 leading-tight mb-1">{selAsset.nombre_activo}</h1>
                        <p className="text-xs text-gray-500 mb-2">{selAsset.id_activo}</p>
                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold border ${selAsset.estado_activo==='Operativo'?'bg-green-50 text-green-700 border-green-200':'bg-red-50 text-red-700 border-red-200'}`}>{selAsset.estado_activo}</span>
                      </div>
                   </div>

                   {(selAsset.foto_1 || selAsset.foto_2 || selAsset.foto_3) && (
                     <div className="flex gap-2 overflow-x-auto mb-6 pb-2">
                       {[selAsset.foto_1, selAsset.foto_2, selAsset.foto_3].map((f, i) => f ? (
                         <div key={i} className="w-16 h-16 rounded border overflow-hidden flex-shrink-0 cursor-pointer hover:opacity-80" onClick={()=>openPreview(f, true)}>
                           <img src={getAppSheetUrl(f)} className="w-full h-full object-cover"/>
                         </div>
                       ) : null)}
                     </div>
                   )}

                   {/* JSON Info (Colapsable y con detección de fotos y FECHA) */}
                   <JsonBlock 
                        title="Ficha Técnica" 
                        data={selAsset.specs} 
                        icon="fa-microchip" 
                        color="text-blue-600" 
                        onLinkClick={(f, isImg) => openPreview(f, isImg)} 
                    />
                   <JsonBlock 
                        title="Mantenimiento" 
                        data={selAsset.protocol} 
                        icon="fa-clipboard-check" 
                        color="text-green-600" 
                        date={selAsset.fecha_actualizacion} 
                        onLinkClick={(f, isImg) => openPreview(f, isImg)} 
                    />
                </div>
              </div>
            )}
          </div>

          {previewFile && (
             <FileModal 
                fileUrl={previewFile.url}
                type={previewFile.type}
                onClose={() => setPreviewFile(null)}
             />
          )}

        </div>
      );
    };

    const getIcon = (type) => {
       const t = (type || '').toLowerCase();
       if(t.includes('cámara') || t.includes('camara')) return 'fa-video';
       if(t.includes('sensor') || t.includes('humo')) return 'fa-fire';
       if(t.includes('control') || t.includes('acceso')) return 'fa-id-card';
       if(t.includes('sirena')) return 'fa-bullhorn';
       return 'fa-circle';
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
