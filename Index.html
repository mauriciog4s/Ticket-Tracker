<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>G4S Ticket Tracker</title>

    <!-- Librerías de React y ReactDOM (Versión de Desarrollo) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel para transpilar JSX en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS vía CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
      /**
       * Configuración personalizada de Tailwind CSS.
       * Define la paleta de colores corporativos de G4S.
       */
      tailwind.config = {
        theme: {
          extend: {
            colors: { appBlue: "#0033A0", appRed: "#D32F2F", appGray: "#F5F5F5" },
          },
        },
      };
    </script>

    <style>
      /* Personalización de la barra de desplazamiento */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
      
      body { font-family: Roboto, system-ui, -apple-system, Segoe UI, sans-serif; background-color: #f3f4f6; }
      
      /* Animaciones de desvanecimiento y entrada */
      .animate-fade-in { animation: fadeIn 0.3s ease-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      
      /* Efecto Skeleton para estados de carga */
      .skeleton { background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; }
      @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
      
      /* Notificaciones tipo Toast */
      .toast { position: fixed; bottom: 20px; right: 20px; background: #1f2937; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 100; font-size: 14px; animation: slideUp 0.3s ease-out; }
      @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
      
      .sync-indicator { font-size: 10px; color: #666; display: flex; align-items: center; gap: 4px; }
      .spin-slow { animation: spin 2s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

      /* Estilos para campos de entrada y etiquetas (estilo Material Design) */
      .input-label { font-size: 0.75rem; color: #6b7280; font-weight: 500; margin-bottom: 0.25rem; display: block; }
      .input-field { width: 100%; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.5rem; font-size: 0.875rem; transition: all 0.2s; outline: none; background: white; }
      .input-field:focus { border-color: #D32F2F; box-shadow: 0 0 0 1px #D32F2F; }
      .section-title { font-size: 0.95rem; font-weight: 600; color: #374151; margin-bottom: 1rem; margin-top: 1.5rem; }
      
      /* Botones de opción de selección única/múltiple */
      .btn-option { border: 1px solid #d1d5db; padding: 0.5rem 1rem; font-size: 0.875rem; color: #4b5563; background: white; transition: all 0.2s; white-space: nowrap; margin-right: -1px; margin-bottom: 4px; }
      .btn-option:hover { background-color: #f9fafb; z-index: 10; position: relative; }
      .btn-option.selected { background-color: #f3f4f6; border-color: #9ca3af; font-weight: 600; color: #111827; z-index: 20; position: relative; }
      .btn-option.selected-red { background-color: #D32F2F; border-color: #D32F2F; color: white; }
      
      /* Utilidades para redondear bordes en grupos de botones */
      .group-start { border-top-left-radius: 0.25rem; border-bottom-left-radius: 0.25rem; }
      .group-end { border-top-right-radius: 0.25rem; border-bottom-right-radius: 0.25rem; }
      .group-single { border-radius: 0.25rem; }
    </style>
  </head>

  <body>
    <!-- ✅ Inyección de la URL del Script para el Proxy de Archivos -->
    <script>
      var SCRIPT_URL = "<?= scriptUrl ?>";
    </script>

    <!-- Contenedor principal de la App de React -->
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef, useCallback } = React;

      /**
       * --- MOCK DATA PARA PRUEBAS LOCALES ---
       * Estos datos se utilizan únicamente si la aplicación se abre fuera del entorno
       * de Google Apps Script (ej: abriendo el archivo localmente en el navegador).
       */
      const MOCK_DATA = {
        userContext: {
          email: "usuario.demo@g4s.com",
          role: "Usuario",
          isValidUser: true,
          isAdmin: false,
          allowedClientIds: ["SEDE-001", "SEDE-002"],
          assignedCustomerNames: ["Banco Demo"], 
          clientNames: { "SEDE-001": "Sede Principal", "SEDE-002": "Sucursal Norte" }
        },
        requests: [
          { "ID Solicitud": "REQ-001", "Ticket G4S": "G10000123", "Estado": "Abierto", "Fecha creación cliente": new Date().toISOString(), "Clasificación": "Hardware", "Prioridad Solicitud": "Alta", "Usuario Actualización": "usuario.demo@g4s.com", "Solicitud": "Fallo en pantalla", "ID Sede": "SEDE-001", "Observación": "Pantalla negra intermitente" },
          { "ID Solicitud": "REQ-002", "Ticket G4S": "G10000124", "Estado": "Cerrado", "Fecha creación cliente": new Date(Date.now() - 86400000).toISOString(), "Clasificación": "Software", "Prioridad Solicitud": "Media", "Usuario Actualización": "admin@g4s.com", "Solicitud": "Instalación Office", "ID Sede": "SEDE-002", "Observación": "Licencia requerida" }
        ],
        classificationOptions: ["Visita técnica", "Visita comercial", "Garantia", "Laboratorio", "HSE"],
        details: {
            "REQ-001": { services: [{ "Observación": "Técnico asignado", "Fecha Actualización": new Date().toISOString() }], history: [], documents: [], activos: [] }
        }
      };

      /**
       * --- runServer ---
       * Puente de comunicación con el backend (Code.gs).
       * Encapsula google.script.run en Promesas y maneja el modo MOCK.
       */
      const runServer = (endpoint, payload = {}) => {
        return new Promise((resolve, reject) => {
          if (typeof google !== "undefined" && google.script) {
            google.script.run
              .withSuccessHandler((res) => {
                if (res && res.error) reject(new Error(res.message || "Error del servidor."));
                else resolve(res);
              })
              .withFailureHandler((err) => reject(err))
              .apiHandler({ endpoint, payload });
          } else {
            // Simulación de respuesta del servidor en entorno local
            console.warn(`⚠️ [MODO MOCK] Llamada simulada: ${endpoint}`, payload);
            setTimeout(() => {
              switch (endpoint) {
                case 'getUserContext': resolve(MOCK_DATA.userContext); break;
                case 'getRequests': resolve({ data: MOCK_DATA.requests, total: MOCK_DATA.requests.length }); break;
                case 'getRequestDetail': resolve({ header: MOCK_DATA.requests.find(r => r["ID Solicitud"] === payload.id) || MOCK_DATA.requests[0], services: [], history: [], documents: [], activos: [] }); break;
                case 'getBatchRequestDetails': 
                  const batchRes = {};
                  (payload.ids || []).forEach(id => batchRes[id] = { services: [], history: [], documents: [], activos: [] });
                  resolve(batchRes); 
                  break;
                case 'createRequest': resolve({ success: true, solicitudId: "NEW-UUID", ticketG4S: "G-NEW-123", row: { "ID Solicitud": "NEW-UUID", "Ticket G4S": "G-NEW-123", "Estado": "Abierto", ...payload, "Fecha creación cliente": new Date().toISOString() } }); break;
                case 'uploadAnexo': resolve({ success: true }); break;
                case 'getActivosCatalog': resolve({ data: [] }); break;
                case 'getActivoByQr': resolve({ found: false }); break;
                case 'createSolicitudActivo': resolve({ success: true }); break;
                case 'getClassificationOptions': resolve(MOCK_DATA.classificationOptions); break;
                default: resolve({});
              }
            }, 800);
          }
        });
      };

      /**
       * --- ICONOS (SVG) ---
       * Colección de iconos Lucide implementados como componentes SVG.
       */
      const Icon = ({ name, size = 20, className = "" }) => {
        const icons = {
          Home: (<><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></>),
          ClipboardList: (<><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M15 2H9a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1Z"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></>),
          History: (<><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></>),
          FileText: (<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>),
          ChevronRight: (<path d="m9 18 6-6-6-6" />),
          User: (<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>),
          AlertTriangle: (<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></>),
          Download: (<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>),
          Settings: (<><path d="M12.22 2h-.44a2 2 0 0 1-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.09a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.09a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.09a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>),
          ShieldCheck: (<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>),
          LogIn: (<><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" x2="3" y1="12" y2="12"/></>),
          Search: (<><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></>),
          RefreshCw: (<><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></>),
          Info: (<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="8"/><line x1="12" x2="12.01" y2="16"/></>),
          CheckCircle: (<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>),
          Clock: (<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>),
          CloudLightning: (<><path d="M19 16.9A5 5 0 0 0 18 7h-1.26a8 8 0 1 0-11.62 9"/><polyline points="13 11 9 17 15 17 11 23"/></>),
          Monitor: (<><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>),
          X: (<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>),
          CheckBig: (<><polyline points="20 6 9 17 4 12"/></>),
          Database: (<><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></>),
          Trash2: (<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>)
        };
        return (
          <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24"
               fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"
               className={className}>
            {icons[name] || <circle cx="12" cy="12" r="10" />}
          </svg>
        );
      };

      /**
       * Toast: Notificación flotante temporal.
       */
      const Toast = ({ message, onClose }) => {
        useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [onClose]);
        return (
          <div className="toast flex items-center gap-2 animate-fade-in">
            <Icon name="Info" className="text-blue-400" />
            <span>{message}</span>
          </div>
        );
      };

      /**
       * SuccessModal: Diálogo de éxito al crear una solicitud.
       */
      const SuccessModal = ({ onClose }) => {
        return (
          <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm animate-fade-in">
            <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full mx-4 relative flex flex-col items-center text-center">
              <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 transition">
                <Icon name="X" size={20} />
              </button>
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 relative">
                <div className="absolute inset-0 bg-green-200 rounded-full animate-ping opacity-25"></div>
                <Icon name="CheckBig" size={40} className="text-green-600" />
              </div>
              <h3 className="text-xl font-bold text-gray-800 mb-2">¡Solicitud Creada!</h3>
              <p className="text-gray-500 text-sm mb-6">Tu ticket ha sido registrado correctamente.</p>
              <button onClick={onClose} className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-xl transition shadow-lg">
                Entendido
              </button>
            </div>
          </div>
        );
      };

      /**
       * Helpers para colores de estado.
       */
      const getStatusTextColor = (status) => {
        const s = String(status || "").toLowerCase();
        if (s === "cerrado" || s.includes("resuelto")) return "text-green-600";
        if (s.includes("abierto") || s.includes("proceso")) return "text-blue-600";
        if (s.includes("cancelado") || s.includes("rechazado")) return "text-red-600";
        return "text-yellow-600";
      };

      const getStatusBadgeColor = (status) => {
        const s = String(status || "").toLowerCase();
        if (s === "cerrado" || s.includes("resuelto")) return "bg-green-100 text-green-700";
        if (s.includes("abierto") || s.includes("proceso")) return "bg-blue-100 text-blue-700";
        if (s.includes("cancelado") || s.includes("rechazado")) return "bg-red-100 text-red-700";
        return "bg-yellow-100 text-yellow-700";
      };

      /**
       * --- ErrorBoundary ---
       * Atrapa errores en el árbol de componentes de React para evitar que la UI se cuelgue.
       */
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false, message: "" };
        }
        static getDerivedStateFromError(error) {
          return { hasError: true, message: error?.message || String(error) };
        }
        render() {
          if (this.state.hasError) {
            return (
              <div className="p-8 max-w-3xl mx-auto">
                <div className="bg-white border border-red-200 rounded-lg p-6 shadow-sm">
                  <h2 className="text-lg font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <Icon name="AlertTriangle" className="text-red-600" /> Error en la interfaz
                  </h2>
                  <pre className="text-xs bg-gray-50 p-3 rounded overflow-auto">{this.state.message}</pre>
                  <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-appRed text-white rounded text-sm font-bold">Reiniciar Aplicación</button>
                </div>
              </div>
            );
          }
          return this.props.children;
        }
      }

      /**
       * --- LoginView ---
       * Pantalla de inicio para autenticación corporativa.
       */
      const LoginView = ({ onSuccess, isCheckingCache, externalError, onClearError }) => {
        const [loading, setLoading] = useState(false);
        if (isCheckingCache) return <div className="flex h-screen items-center justify-center bg-gray-100"><Icon name="RefreshCw" className="animate-spin text-gray-400" size={32} /></div>;

        return (
          <div className="flex h-screen items-center justify-center bg-gray-100 p-4">
            <div className="bg-white p-10 rounded-2xl shadow-xl max-w-md w-full text-center">
              <img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" alt="G4S" className="h-16 mx-auto mb-6" />
              <h1 className="text-2xl font-bold text-gray-800 mb-1">Ticket Tracker</h1>
              <p className="text-gray-400 mb-8 text-sm">Gestión de Tecnología & Servicios</p>

              {externalError && (
                <div className="mb-6 bg-red-50 border border-red-200 text-red-700 p-3 rounded-lg text-sm text-left flex gap-2">
                  <Icon name="AlertTriangle" size={18} className="shrink-0" /> <span>{externalError}</span>
                </div>
              )}

              <button
                onClick={async () => { setLoading(true); try { await onSuccess(); } catch(e) { setLoading(false); } }}
                disabled={loading}
                className="w-full bg-appBlue hover:bg-blue-800 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-3 transition"
              >
                {loading ? <Icon name="RefreshCw" className="animate-spin" size={20} /> : <><Icon name="User" size={20} /> Ingresar con Google</>}
              </button>
            </div>
          </div>
        );
      };

      /**
       * --- Sidebar ---
       * Navegación lateral y sección de usuario.
       */
      const Sidebar = ({ currentView, setView, onLogout, userContext, lastSyncRequests, isSyncing, onRefreshContext }) => {
        const menuItems = [
          { id: "home", icon: "Home", title: "Inicio" },
          { id: "create", icon: "ClipboardList", title: "Nueva Solicitud" },
          { id: "process", icon: "Monitor", title: "Tickets Activos" },
          { id: "history", icon: "History", title: "Historial Tickets" },
          { id: "assets", icon: "Database", title: "Activos" },
        ];

        return (
          <div className="w-64 bg-white h-screen border-r border-gray-200 flex flex-col shadow-lg z-10 fixed">
            <div className="p-6 border-b border-gray-100 flex items-center gap-3 cursor-pointer" onClick={() => setView("home")}>
              <img src="https://www.g4s.com/es-co/-/media/g4s/global/images/logos/g4s---an-allied-universal-company-logo/g4s_one-company_logo_180x136.ashx" alt="G4S" className="h-8" />
              <span className="font-bold text-gray-800 text-lg">Tracker</span>
            </div>

            <div className="flex-1 overflow-y-auto py-4">
              {menuItems.map((item) => (
                <div key={item.id} onClick={() => setView(item.id)} className={`px-6 py-3 cursor-pointer transition-colors border-l-4 ${currentView === item.id ? "bg-red-50 border-appRed text-appRed font-bold" : "border-transparent text-gray-600 hover:bg-gray-50"}`}>
                  <div className="flex items-center gap-3">
                    <Icon name={item.icon} size={20} /> <span className="text-sm">{item.title}</span>
                  </div>
                </div>
              ))}
              <div className="my-2 border-t border-gray-100"></div>
              <div onClick={() => setView("config")} className={`px-6 py-3 cursor-pointer transition-colors border-l-4 ${currentView === "config" ? "bg-blue-50 border-appBlue text-appBlue font-bold" : "border-transparent text-gray-600 hover:bg-gray-50"}`}>
                <div className="flex items-center gap-3">
                  <Icon name="Settings" size={20} /> <span className="text-sm">Configuración</span>
                </div>
              </div>
            </div>

            <div className="p-4 border-t bg-gray-50">
              <div className="flex flex-col gap-3 mb-4 text-xs">
                <div>
                   <div className="flex justify-between items-center text-gray-400 font-bold uppercase mb-1">
                     <span>Cliente</span>
                     <button onClick={onRefreshContext} className="hover:text-blue-600 transition"><Icon name="RefreshCw" size={12} /></button>
                   </div>
                   <div className="font-bold text-blue-900 truncate">{userContext?.assignedCustomerNames?.join(", ") || "Sedes Varias"}</div>
                </div>
                <div className="flex items-center gap-2">
                   <div className="p-2 rounded-full bg-gray-200 text-gray-600"><Icon name="User" size={16} /></div>
                   <div className="truncate font-bold text-gray-700">{userContext?.email}</div>
                </div>
              </div>
              <button onClick={onLogout} className="w-full py-2 bg-white border border-gray-300 rounded font-bold text-gray-700 hover:bg-gray-100 flex items-center justify-center gap-2 transition">
                <Icon name="LogIn" size={14} className="rotate-180" /> Salir
              </button>
            </div>
          </div>
        );
      };

      /**
       * --- CreateRequest ---
       * Formulario complejo para la creación de nuevos tickets con adjuntos y activos.
       */
      const CreateRequest = ({ userContext, setView, onRefresh, showToast }) => {
        // Estado local del formulario
        const [formData, setFormData] = useState({
          idSede: "", ticketCliente: "", clasificacion: "Hardware",
          tipoServicio: "Visita técnica", prioridad: "Media", solicitud: "", observacion: ""
        });

        const [submitting, setSubmitting] = useState(false);
        const [showSuccess, setShowSuccess] = useState(false);
        const [classificationOptions, setClassificationOptions] = useState([]);
        const [loadingOptions, setLoadingOptions] = useState(false);
        const [attachments, setAttachments] = useState([]);
        const [activos, setActivos] = useState([]);
        const [showActivosModal, setShowActivosModal] = useState(false);
        const fileInputRef = useRef(null);

        // Cargar opciones dinámicas de clasificación
        useEffect(() => {
          setLoadingOptions(true);
          runServer('getClassificationOptions')
            .then(opts => { if(Array.isArray(opts)) setClassificationOptions(opts); })
            .finally(() => setLoadingOptions(false));
        }, []);

        const handleChange = (field, value) => setFormData(prev => ({ ...prev, [field]: value }));

        /**
         * Manejo de archivos adjuntos.
         */
        const handleFileSelection = (e) => {
          const files = Array.from(e.target.files || []);
          const mapped = files.map(f => ({
            id: Math.random().toString(36).substr(2, 9),
            file: f, tipo: f.type.startsWith("image/") ? "Foto" : "Archivo", status: "ready"
          }));
          setAttachments(prev => [...prev, ...mapped]);
        };

        const uploadAll = async (solicitudId) => {
          for (const att of attachments) {
            const reader = new FileReader();
            const base64Promise = new Promise((res) => {
              reader.onload = () => res(reader.result.split(',')[1]);
              reader.readAsDataURL(att.file);
            });
            const base64 = await base64Promise;
            await runServer("uploadAnexo", { solicitudId, tipoAnexo: att.tipo, fileName: att.file.name, mimeType: att.file.type, base64 });
          }
        };

        const handleSubmit = async () => {
          if (!formData.idSede || !formData.solicitud || !formData.observacion) return alert("Complete los campos requeridos.");
          setSubmitting(true);
          try {
            const res = await runServer('createRequest', formData);
            const solicitudId = res.solicitudId;
            if (attachments.length) await uploadAll(solicitudId);
            for (const a of activos) {
              await runServer("createSolicitudActivo", { solicitudId, qrSerial: a.qrSerial, idActivo: a.idActivo });
            }
            setShowSuccess(true);
          } catch (err) {
            alert("Error: " + err.message);
            setSubmitting(false);
          }
        };

        return (
          <div className="p-8 max-w-4xl mx-auto animate-fade-in relative">
            {showSuccess && <SuccessModal onClose={() => { setShowSuccess(false); onRefresh(); setView("home"); }} />}

            <div className="flex justify-between items-center mb-8">
               <h2 className="text-2xl font-bold text-gray-800">Crear Solicitud</h2>
               <div className="flex gap-2">
                 <button onClick={() => setView("home")} className="px-4 py-2 border rounded font-bold text-gray-600 hover:bg-gray-50 transition">Cancelar</button>
                 <button onClick={handleSubmit} disabled={submitting} className="bg-appRed text-white px-6 py-2 rounded shadow hover:bg-red-700 font-bold transition flex items-center gap-2">
                    {submitting ? <Icon name="RefreshCw" className="animate-spin" size={16} /> : "Guardar Ticket"}
                 </button>
               </div>
            </div>

            <div className="bg-white p-8 rounded-xl shadow-sm border border-gray-200 space-y-8">
              {/* Sección Sitio */}
              <div>
                <h3 className="section-title mt-0">Ubicación y Sede</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="input-label">Sede de Servicio *</label>
                    <select className="input-field" value={formData.idSede} onChange={(e) => handleChange("idSede", e.target.value)}>
                      <option value="">Seleccione una sede...</option>
                      {userContext?.allowedClientIds?.map(id => (
                        <option key={id} value={id}>{userContext.clientNames[id] || id}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="input-label">Ticket Externo (Opcional)</label>
                    <input type="text" className="input-field" placeholder="ID Ticket del Cliente" value={formData.ticketCliente} onChange={(e) => handleChange("ticketCliente", e.target.value)} />
                  </div>
                </div>
              </div>

              {/* Sección Motivo */}
              <div>
                <h3 className="section-title">Detalle del Servicio</h3>
                <div className="space-y-4">
                  <div>
                    <label className="input-label">Solicitud *</label>
                    <input type="text" className="input-field" placeholder="Breve descripción del problema" value={formData.solicitud} onChange={(e) => handleChange("solicitud", e.target.value)} />
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div>
                       <label className="input-label">Tipo de Clasificación</label>
                       <select className="input-field" value={formData.clasificacion} onChange={(e) => handleChange("clasificacion", e.target.value)}>
                         <option value="Hardware">Hardware</option>
                         <option value="Software">Software</option>
                         <option value="Redes">Redes</option>
                         <option value="Acceso">Acceso</option>
                         <option value="Otro">Otro</option>
                       </select>
                     </div>
                     <div>
                       <label className="input-label">Prioridad</label>
                       <div className="flex">
                         {["Baja", "Media", "Alta"].map((p, i, a) => (
                           <button key={p} type="button" onClick={() => handleChange("prioridad", p)} className={`btn-option flex-1 ${formData.prioridad === p ? "selected-red" : ""} ${i===0?"group-start":i===a.length-1?"group-end":""}`}>{p}</button>
                         ))}
                       </div>
                     </div>
                  </div>
                  <div>
                    <label className="input-label">Observaciones Técnicas *</label>
                    <textarea className="input-field h-24" placeholder="Escriba aquí los detalles adicionales..." value={formData.observacion} onChange={(e) => handleChange("observacion", e.target.value)}></textarea>
                  </div>
                </div>
              </div>

              {/* Sección Adjuntos */}
              <div>
                <h3 className="section-title">Adjuntos y Activos</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                    <div className="flex justify-between items-center mb-4">
                       <span className="text-sm font-bold text-gray-600">Archivos ({attachments.length})</span>
                       <button onClick={() => fileInputRef.current.click()} className="text-xs font-bold text-appRed hover:underline">+ Agregar</button>
                    </div>
                    <input type="file" ref={fileInputRef} className="hidden" multiple onChange={handleFileSelection} />
                    <div className="space-y-2 max-h-32 overflow-y-auto">
                      {attachments.map(a => (
                        <div key={a.id} className="flex items-center justify-between text-xs bg-white p-2 rounded shadow-sm">
                           <span className="truncate w-40">{a.file.name}</span>
                           <button onClick={() => setAttachments(prev => prev.filter(x => x.id !== a.id))} className="text-gray-400 hover:text-red-500"><Icon name="X" size={14} /></button>
                        </div>
                      ))}
                    </div>
                  </div>
                  <div className="p-4 bg-gray-50 rounded-lg border border-dashed border-gray-300">
                    <div className="flex justify-between items-center mb-4">
                       <span className="text-sm font-bold text-gray-600">Activos QR ({activos.length})</span>
                       <button onClick={() => alert("Función de vinculación de activos disponible próximamente.")} className="text-xs font-bold text-appRed hover:underline">+ Escanear</button>
                    </div>
                    <p className="text-[10px] text-gray-400 italic">Vincule los activos escaneando su código QR.</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      /**
       * --- RequestDetail ---
       * Visualización de un ticket existente.
       */
      const RequestDetail = ({ requestId, onBack, preloadedData }) => {
        const [data, setData] = useState(null);
        useEffect(() => {
          runServer("getRequestDetail", { id: requestId }).then(setData);
        }, [requestId]);

        if (!data) return <div className="p-20 text-center"><Icon name="RefreshCw" className="animate-spin mx-auto mb-4" size={32} /> Cargando ticket...</div>;

        const openAnexo = (id) => window.open(`${SCRIPT_URL}?v=archivo&id=${id}`, "_blank");

        return (
          <div className="p-8 max-w-7xl mx-auto animate-fade-in">
            <button onClick={onBack} className="mb-6 text-gray-500 hover:text-gray-800 flex items-center gap-2 font-bold text-sm">
              <Icon name="ChevronRight" size={16} className="rotate-180" /> Volver al Historial
            </button>
            <div className="grid grid-cols-12 gap-8">
              <div className="col-span-12 md:col-span-8">
                <div className="bg-white rounded-xl shadow-sm border p-6">
                  <h3 className="font-bold text-gray-700 uppercase text-xs mb-6 border-b pb-2">Datos de la Solicitud</h3>
                  <div className="grid grid-cols-2 gap-y-6 gap-x-4">
                    {Object.entries(data.header).map(([k, v]) => (
                      (v && v !== "0") && <div key={k}>
                        <div className="text-[10px] text-gray-400 font-bold uppercase tracking-tighter">{k}</div>
                        <div className="text-sm text-gray-800 font-medium break-words">{String(v)}</div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
              <div className="col-span-12 md:col-span-4 space-y-6">
                <div className="bg-white p-6 rounded-xl shadow-sm border text-center">
                   <div className="text-gray-400 text-xs font-bold mb-1 uppercase">Estado</div>
                   <div className={`text-2xl font-black uppercase ${getStatusTextColor(data.header.Estado)}`}>{data.header.Estado}</div>
                   <div className="text-[10px] text-gray-400 mt-1">Ticket: {data.header["Ticket G4S"] || "N/A"}</div>
                </div>
                {/* Adjuntos */}
                <div className="bg-white p-6 rounded-xl shadow-sm border">
                   <h3 className="font-bold text-gray-700 text-xs uppercase mb-4">Documentos y Anexos</h3>
                   <div className="space-y-2">
                     {data.documents?.length ? data.documents.map((doc, i) => (
                       <button key={i} onClick={() => openAnexo(doc["ID Solicitudes anexos"])} className="w-full text-left p-3 border rounded-lg hover:bg-gray-50 flex items-center gap-3 transition">
                         <Icon name="FileText" className="text-red-500 shrink-0" />
                         <div className="flex-1 overflow-hidden">
                           <div className="text-xs font-bold truncate">{doc.Nombre || "Archivo"}</div>
                           <div className="text-[10px] text-gray-400">{doc["Tipo anexo"]}</div>
                         </div>
                         <Icon name="Download" size={14} className="text-gray-300" />
                       </button>
                     )) : <p className="text-xs text-gray-400 italic">No hay adjuntos registrados.</p>}
                   </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      /**
       * --- RequestList ---
       * Listado tabular de tickets con filtros.
       */
      const RequestList = ({ setView, setSelectedRequest, initialData, onRefresh, refreshing }) => {
        const [filter, setFilter] = useState("Todo");
        const [search, setSearch] = useState("");
        const requests = initialData?.data || [];

        const filtered = useMemo(() => {
          return requests.filter(r => {
            const matchesFilter = filter === "Todo" || (filter === "Abierto" && r.Estado !== "Cerrado") || (filter === "Cerrado" && r.Estado === "Cerrado");
            const matchesSearch = !search || JSON.stringify(r).toLowerCase().includes(search.toLowerCase());
            return matchesFilter && matchesSearch;
          });
        }, [requests, filter, search]);

        return (
          <div className="p-8 flex flex-col h-screen">
             <div className="flex justify-between items-center mb-6">
                <div className="flex gap-2">
                   {["Todo", "Abierto", "Cerrado"].map(f => (
                     <button key={f} onClick={() => setFilter(f)} className={`px-4 py-1.5 rounded-full text-xs font-bold transition ${filter === f ? "bg-gray-800 text-white" : "bg-white border text-gray-600 hover:bg-gray-50"}`}>{f}</button>
                   ))}
                </div>
                <div className="relative w-64">
                   <Icon name="Search" className="absolute left-3 top-2 text-gray-400" size={16} />
                   <input className="w-full pl-10 pr-4 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Buscar..." value={search} onChange={(e) => setSearch(e.target.value)} />
                </div>
             </div>

             <div className="bg-white rounded-xl shadow-sm border overflow-hidden flex-1 overflow-y-auto">
               <table className="w-full text-left text-sm">
                 <thead className="bg-gray-50 text-gray-400 uppercase text-[10px] font-bold border-b">
                   <tr>
                     <th className="px-6 py-4">Ticket</th>
                     <th className="px-6 py-4">Fecha</th>
                     <th className="px-6 py-4">Solicitud</th>
                     <th className="px-6 py-4">Sede</th>
                     <th className="px-6 py-4 text-right">Estado</th>
                   </tr>
                 </thead>
                 <tbody className="divide-y">
                   {filtered.map((r, i) => (
                     <tr key={i} onClick={() => { setSelectedRequest(r); setView("detail"); }} className="hover:bg-blue-50 cursor-pointer transition">
                       <td className="px-6 py-4 font-bold text-blue-700">{r["Ticket G4S"] || r["ID Solicitud"].substr(0,8)}</td>
                       <td className="px-6 py-4 text-gray-500">{new Date(r["Fecha creación cliente"]).toLocaleDateString()}</td>
                       <td className="px-6 py-4 font-medium truncate max-w-xs">{r.Solicitud}</td>
                       <td className="px-6 py-4 text-gray-400">{r["ID Sede"]}</td>
                       <td className="px-6 py-4 text-right"><span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${getStatusBadgeColor(r.Estado)}`}>{r.Estado}</span></td>
                     </tr>
                   ))}
                 </tbody>
               </table>
               {filtered.length === 0 && <div className="p-20 text-center text-gray-400 italic">No se encontraron tickets.</div>}
             </div>
          </div>
        );
      };

      /**
       * --- AssetsView ---
       * Listado de activos tecnológicos.
       */
      const AssetsView = ({ userContext }) => {
        const [assets, setAssets] = useState([]);
        const [loading, setLoading] = useState(true);
        const [search, setSearch] = useState("");

        useEffect(() => {
          runServer('getActivosCatalog')
            .then(res => {
              if (res && res.data) setAssets(res.data);
            })
            .catch(err => console.error("Error loading assets:", err))
            .finally(() => setLoading(false));
        }, []);

        const filtered = useMemo(() => {
          return assets.filter(a => {
            const str = `${a.idActivo} ${a.nombreActivo} ${a.qrSerial} ${a.nombreUbicacion}`.toLowerCase();
            return !search || str.includes(search.toLowerCase());
          });
        }, [assets, search]);

        return (
          <div className="p-8 flex flex-col h-screen">
             <div className="flex justify-between items-center mb-6">
                <h2 className="text-2xl font-bold text-gray-800">Catálogo de Activos</h2>
                <div className="relative w-64">
                   <Icon name="Search" className="absolute left-3 top-2 text-gray-400" size={16} />
                   <input
                     className="w-full pl-10 pr-4 py-1.5 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none"
                     placeholder="Buscar activo..."
                     value={search}
                     onChange={(e) => setSearch(e.target.value)}
                   />
                </div>
             </div>

             <div className="bg-white rounded-xl shadow-sm border overflow-hidden flex-1 overflow-y-auto">
               {loading ? (
                 <div className="p-20 text-center text-gray-400 flex flex-col items-center gap-4">
                   <Icon name="RefreshCw" className="animate-spin" size={32} />
                   <p>Cargando catálogo de activos...</p>
                 </div>
               ) : (
                 <table className="w-full text-left text-sm">
                   <thead className="bg-gray-50 text-gray-400 uppercase text-[10px] font-bold border-b">
                     <tr>
                       <th className="px-6 py-4">ID Activo</th>
                       <th className="px-6 py-4">Nombre</th>
                       <th className="px-6 py-4">QR / Serial</th>
                       <th className="px-6 py-4">Ubicación</th>
                       <th className="px-6 py-4 text-right">Estado</th>
                     </tr>
                   </thead>
                   <tbody className="divide-y">
                     {filtered.map((a, i) => (
                       <tr key={i} className="hover:bg-gray-50 transition">
                         <td className="px-6 py-4 font-bold text-gray-700">{a.idActivo}</td>
                         <td className="px-6 py-4 font-medium">{a.nombreActivo}</td>
                         <td className="px-6 py-4 text-gray-500 font-mono text-xs">{a.qrSerial}</td>
                         <td className="px-6 py-4 text-gray-400">{a.nombreUbicacion}</td>
                         <td className="px-6 py-4 text-right">
                           <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase ${a.estadoActivo?.toLowerCase().includes("activo") ? "bg-green-100 text-green-700" : "bg-gray-100 text-gray-600"}`}>
                             {a.estadoActivo}
                           </span>
                         </td>
                       </tr>
                     ))}
                   </tbody>
                 </table>
               )}
               {!loading && filtered.length === 0 && <div className="p-20 text-center text-gray-400 italic">No se encontraron activos.</div>}
             </div>
          </div>
        );
      };

      /**
       * --- HomeDashboard ---
       * Panel principal de métricas.
       */
      const HomeDashboard = ({ userContext, requests, setView }) => {
        const stats = useMemo(() => {
          const total = requests.length;
          const open = requests.filter(r => (r.Estado || "").toLowerCase() !== "cerrado").length;
          return { total, open, closed: total - open };
        }, [requests]);

        return (
          <div className="p-8 max-w-6xl mx-auto animate-fade-in">
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Hola, {userContext.email.split("@")[0]}</h1>
            <p className="text-gray-500 mb-10">Bienvenido al portal de gestión corporativa de G4S.</p>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div className="text-gray-400 text-[10px] font-black uppercase tracking-widest mb-2">Tickets Totales</div>
                <div className="text-4xl font-black text-gray-800">{stats.total}</div>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 border-l-4 border-l-yellow-400">
                <div className="text-gray-400 text-[10px] font-black uppercase tracking-widest mb-2">Pendientes</div>
                <div className="text-4xl font-black text-yellow-600">{stats.open}</div>
              </div>
              <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 border-l-4 border-l-green-400">
                <div className="text-gray-400 text-[10px] font-black uppercase tracking-widest mb-2">Completados</div>
                <div className="text-4xl font-black text-green-600">{stats.closed}</div>
              </div>
            </div>

            <button onClick={() => setView("create")} className="bg-gradient-to-br from-appRed to-red-800 text-white p-8 rounded-3xl shadow-xl shadow-red-200 flex items-center gap-6 hover:scale-[1.03] transition transform group w-full md:w-auto">
               <div className="bg-white/20 p-4 rounded-2xl group-hover:rotate-12 transition-transform"><Icon name="ClipboardList" size={48} /></div>
               <div className="text-left">
                  <div className="text-2xl font-bold">Crear nueva Solicitud</div>
                  <div className="text-red-100 opacity-80">Reporte técnico o requerimiento de servicio</div>
               </div>
            </button>
          </div>
        );
      };

      /**
       * --- ConfigurationView ---
       * Panel de configuración y reporte de sincronización masiva.
       */
      const ConfigurationView = ({ userContext, onForceSync, onClearCache, isSyncing, lastSyncRequests, lastSyncDetails, syncReport }) => {
        return (
          <div className="p-8 max-w-4xl mx-auto animate-fade-in">
            <div className="flex justify-between items-center mb-8">
              <h2 className="text-2xl font-bold text-gray-800">Configuración</h2>
              <button onClick={onForceSync} disabled={isSyncing} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700 transition flex items-center gap-2 disabled:opacity-50 shadow-sm">
                <Icon name="RefreshCw" size={16} className={isSyncing ? "animate-spin" : ""} />
                {isSyncing ? "Sincronizando..." : "Sincronizar Todo (Offline)"}
              </button>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                <div className="flex items-center gap-6 mb-8">
                  <div className="h-20 w-20 bg-blue-100 rounded-3xl flex items-center justify-center text-blue-600 font-black text-2xl">G4S</div>
                  <div>
                    <div className="text-xs uppercase font-bold text-gray-500 mb-1">Cuenta Activa</div>
                    <div className="text-xl font-bold text-gray-800 truncate w-48">{userContext?.email}</div>
                    <div className="inline-flex items-center gap-1 bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold mt-3"><Icon name="ShieldCheck" size={14} /> {userContext?.role}</div>
                  </div>
                </div>
                <button onClick={onClearCache} className="w-full py-3 px-4 bg-red-50 text-red-600 rounded-xl font-bold hover:bg-red-100 transition flex items-center justify-center gap-2">
                  <Icon name="Trash2" size={18} /> Limpiar Datos y Salir
                </button>
              </div>

              <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-200">
                 <h3 className="font-bold text-gray-700 mb-6 flex items-center gap-2 text-sm uppercase tracking-wider"><Icon name="Database" size={18} className="text-blue-600" /> Estado de Almacenamiento Local</h3>
                 {syncReport ? (
                    <div className="space-y-4">
                      <div className="flex justify-between items-center text-sm p-3 bg-gray-50 rounded-lg">
                        <span className="text-gray-600 flex items-center gap-2"><Icon name="ClipboardList" size={16}/> Tickets</span>
                        <span className="font-black text-gray-800">{syncReport.requests}</span>
                      </div>
                       <div className="flex justify-between items-center text-sm p-3 bg-gray-50 rounded-lg">
                        <span className="text-gray-600 flex items-center gap-2"><Icon name="FileText" size={16}/> Observaciones</span>
                        <span className="font-black text-gray-800">{syncReport.obs}</span>
                      </div>
                       <div className="flex justify-between items-center text-sm p-3 bg-gray-50 rounded-lg">
                        <span className="text-gray-600 flex items-center gap-2"><Icon name="History" size={16}/> Historial</span>
                        <span className="font-black text-gray-800">{syncReport.hist}</span>
                      </div>
                       <div className="flex justify-between items-center text-sm p-3 bg-gray-50 rounded-lg">
                        <span className="text-gray-600 flex items-center gap-2"><Icon name="Download" size={16}/> Anexos</span>
                        <span className="font-black text-gray-800">{syncReport.anx}</span>
                      </div>
                    </div>
                 ) : <div className="p-10 text-center text-xs text-gray-400 italic">No hay datos sincronizados para uso offline.</div>}
              </div>
            </div>
          </div>
        );
      };

      /**
       * --- App ---
       * Componente raíz y orquestador del estado global de la aplicación.
       * Implementa el sistema de caché masiva y sincronización por lotes.
       */
      const App = () => {
        const [userCtx, setUserCtx] = useState(null);
        const [initialData, setInitialData] = useState({ data: [], total: 0 });
        const [detailsCache, setDetailsCache] = useState({}); 
        const [view, setView] = useState("home");
        const [selectedRequest, setSelectedRequest] = useState(null);
        
        const [isSyncing, setIsSyncing] = useState(false);
        const [lastSyncRequests, setLastSyncRequests] = useState(null);
        const [lastSyncDetails, setLastSyncDetails] = useState(null);
        const [syncReport, setSyncReport] = useState(null); 
        
        const [toast, setToast] = useState(null);
        const [loginError, setLoginError] = useState(null);
        const [isCheckingCache, setIsCheckingCache] = useState(true);

        const showToast = (msg) => setToast(msg);

        // --- GESTIÓN DE CACHÉ LOCAL (LocalStorage) ---
        const getCacheKey = (type, email) => `g4s_${type}_${email?.toLowerCase()}`;

        const loadFromCache = (email) => {
          try {
            const reqs = localStorage.getItem(getCacheKey("reqs", email));
            const dets = localStorage.getItem(getCacheKey("dets", email));
            const ctx = localStorage.getItem(getCacheKey("ctx", email));
            return {
              requests: reqs ? JSON.parse(reqs) : null,
              details: dets ? JSON.parse(dets) : null,
              context: ctx ? JSON.parse(ctx) : null
            };
          } catch(e) { return {}; }
        };

        const updateSyncReport = (reqCount, detailsMap) => {
          let obs = 0, hist = 0, anx = 0;
          Object.values(detailsMap).forEach(d => {
            if (d.services) obs += d.services.length;
            if (d.history) hist += d.history.length;
            if (d.documents) anx += d.documents.length;
          });
          setSyncReport({ requests: reqCount, obs, hist, anx });
        };

        /**
         * Sincronización masiva de datos (Tickets y Tablas Anexas).
         * Implementa descarga por lotes (batching) y procesamiento paralelo.
         */
        const refreshData = async (manual = false, emailOverride = null) => {
          const email = emailOverride || userCtx?.email;
          if (!email || isSyncing) return;

          setIsSyncing(true);
          if (manual) showToast("Iniciando sincronización completa...");

          try {
            // 1. Descargar listado de solicitudes
            const reqData = await runServer("getRequests");
            setInitialData(reqData);
            const ts = Date.now();
            localStorage.setItem(getCacheKey("reqs", email), JSON.stringify({ data: reqData, timestamp: ts }));
            setLastSyncRequests(ts);

            // 2. Descargar detalles por lotes (Paralelizado)
            if (reqData.data && reqData.data.length > 0) {
              const allIds = reqData.data.map(r => r["ID Solicitud"]).filter(Boolean);
              const CHUNK_SIZE = 40;
              const chunks = [];
              for (let i = 0; i < allIds.length; i += CHUNK_SIZE) chunks.push(allIds.slice(i, i + CHUNK_SIZE));
              
              let newDetails = {};
              // Procesar lotes de 5 en 5 para no saturar el servidor
              for (let i = 0; i < chunks.length; i += 5) {
                 const batchResults = await Promise.all(chunks.slice(i, i + 5).map(chunk => runServer("getBatchRequestDetails", { ids: chunk })));
                 batchResults.forEach(res => { newDetails = { ...newDetails, ...res }; });
              }

              setDetailsCache(newDetails);
              localStorage.setItem(getCacheKey("dets", email), JSON.stringify({ data: newDetails, timestamp: ts }));
              setLastSyncDetails(ts);
              updateSyncReport(reqData.data.length, newDetails);
            }

            if (manual) showToast("✅ Datos actualizados correctamente.");
          } catch (e) {
            if (manual) showToast("❌ Error al sincronizar: " + e.message);
          } finally { setIsSyncing(false); }
        };

        const handleRefreshContext = async () => {
          if (!userCtx) return;
          showToast("Actualizando permisos...");
          try {
            const newCtx = await runServer("getUserContext", { ignoreCache: true });
            setUserCtx(newCtx);
            localStorage.setItem(getCacheKey("ctx", newCtx.email), JSON.stringify(newCtx));
            localStorage.setItem("last_user_it", newCtx.email);
            showToast("✅ Permisos actualizados.");
            refreshData(false, newCtx.email);
          } catch(e) { showToast("❌ Error al actualizar permisos."); }
        };

        const handleLoginAttempt = async () => {
          setLoginError(null);
          try {
            const serverCtx = await runServer("getUserContext");
            if (!serverCtx.isValidUser) throw new Error("Acceso no autorizado.");
            
            setUserCtx(serverCtx);
            localStorage.setItem(getCacheKey("ctx", serverCtx.email), JSON.stringify(serverCtx));
            localStorage.setItem("last_user_it", serverCtx.email);
            setView("home");
            refreshData(true, serverCtx.email);
          } catch (e) { setLoginError(e.message); }
        };

        // Carga inicial (desde caché si existe)
        useEffect(() => {
          const lastUser = localStorage.getItem("last_user_it");
          if (lastUser) {
            const cache = loadFromCache(lastUser);
            if (cache.context && cache.requests) {
              setUserCtx(cache.context);
              setInitialData(cache.requests.data);
              setLastSyncRequests(cache.requests.timestamp);
              if (cache.details) {
                setDetailsCache(cache.details.data);
                setLastSyncDetails(cache.details.timestamp);
                updateSyncReport(cache.requests.data.data.length, cache.details.data);
              }
              setView("home");
              refreshData(false, lastUser); // Sync silencioso en BG
            }
          }
          setIsCheckingCache(false);
        }, []);

        if (!userCtx) return <LoginView onSuccess={handleLoginAttempt} isCheckingCache={isCheckingCache} externalError={loginError} />;

        return (
          <div className="flex min-h-screen bg-gray-100 text-gray-800">
            <Sidebar 
              currentView={view} setView={setView} userContext={userCtx}
              isSyncing={isSyncing} lastSyncRequests={lastSyncRequests}
              onLogout={() => { localStorage.clear(); window.location.reload(); }}
              onRefreshContext={handleRefreshContext} 
            />
            <div className="flex-1 ml-64 overflow-y-auto h-screen">
              {view === "home" && <HomeDashboard userContext={userCtx} requests={initialData.data} setView={setView} />}
              {view === "assets" && <AssetsView userContext={userCtx} />}
              {view === "create" && <CreateRequest userContext={userCtx} setView={setView} onRefresh={() => refreshData(true)} showToast={showToast} />}
              {view === "detail" && <RequestDetail requestId={selectedRequest?.["ID Solicitud"]} onBack={() => setView("history")} preloadedData={selectedRequest} />}
              {(view === "history" || view === "process") && <RequestList setView={setView} setSelectedRequest={setSelectedRequest} initialData={initialData} onRefresh={() => refreshData(true)} refreshing={isSyncing} />}
              {view === "config" && (
                <ConfigurationView 
                  userContext={userCtx} onForceSync={() => refreshData(true)}
                  onClearCache={() => { localStorage.clear(); window.location.reload(); }}
                  isSyncing={isSyncing} lastSyncRequests={lastSyncRequests}
                  lastSyncDetails={lastSyncDetails} syncReport={syncReport}
                />
              )}
            </div>
            {toast && <Toast message={toast} onClose={() => setToast(null)} />}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
  </body>
</html>
